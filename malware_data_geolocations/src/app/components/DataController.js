import gql from 'graphql-tag';
import React from 'react';
import { withApollo } from 'react-apollo';

import DataGrid from './DataGrid';
import MapContainer from './MapContainer';
import { malwareData } from '../../assets/malware_data';
import Pages from './Pages';

class DataController extends React.Component {
  constructor(props) {
    super(props);

    this.state = {
      data: [],
      locations: [],
      selectedLocations: [],
      searchResults: [],
      totalDataCount: 0,
      currentPage: 1,
    };

    this.selectLocation = this.selectLocation.bind(this);
    this.onSearchSubmit = this.onSearchSubmit.bind(this);
    this.onPageClick = this.onPageClick.bind(this);
  }

  componentDidMount() {

    // get data
    this.props.client.query({
      query: gql`
        query GetData {
          getData(first: 100, offset: 0) {
            date,
            ip,
            description,
            domain,
            asn,
            country,
            registrant,
            reverse_lookup
          }
        }
      `
    })
    .then((response) => {
      this.setState({
        data: response.data.getData
      });

      response.data.getData.map(data => {
        fetch(`https://www.extreme-ip-lookup.com/json/${data.ip}`)
        .then(response => response.json())
        .then(json => {
          this.setState({
            locations: [
              ...this.state.locations,
              {
                lat: json.lat,
                lng: json.lon
              }
            ]
          })
        })
      });
    });

    // get total data count
    this.props.client.query({
      query: gql`
        query GetCount {
          totalCount
        }
      `
    })
    .then(response => {
      this.setState({
        totalDataCount: response.data.totalCount
      }, () => console.log(this.state.totalDataCount))
    });
  }

  onPageClick(e, currentPage, nextPage) {
    // if nextPage equals currentPage, don't do anything
    if (nextPage === currentPage)
      return;

    this.setState({
      currentPage: nextPage
    });

    e.currentTarget.children[currentPage].classList.remove('active');
    e.currentTarget.children[nextPage].classList.add('active');

    // retrieve data using page offset
    this.props.client.query({
      query: gql`
        query GetData($offset: Int!) {
          getData(first: 100, offset: $offset) {
            date,
            ip,
            description,
            domain,
            asn,
            country,
            registrant,
            reverse_lookup
          }
        }
      `,
      variables: {
        offset: (nextPage-1)*100
      }
    })
    .then((response) => {
      this.setState({
        data: response.data.getData,
        locations: []
      });

      response.data.getData.map(data => {
        fetch(`https://www.extreme-ip-lookup.com/json/${data.ip}`)
        .then(response => response.json())
        .then(json => {
          this.setState({
            locations: [
              ...this.state.locations,
              {
                lat: json.lat,
                lng: json.lon
              }
            ]
          })
        })
      });
    });
  }

  onSearchSubmit(searchValue) {
    this.props.client.query({
      query: gql`
        query search($searchValue: String!) {
          search(searchValue: $searchValue) {
            date,
            ip,
            description,
            domain,
            asn,
            country,
            registrant,
            reverse_lookup
          }
        }
      `,
      variables: {
        searchValue: searchValue
      }
    })
    .then(response => {
      this.setState({
        data: response.data.search,
        totalDataCount: response.data.search.length,
        currentPage: 1,
        locations: []
      });

      response.data.search.map(data => {
        fetch(`https://www.extreme-ip-lookup.com/json/${data.ip}`)
        .then(response => response.json())
        .then(json => {
          this.setState({
            locations: [
              ...this.state.locations,
              {
                lat: json.lat,
                lng: json.lon
              }
            ]
          })
        })
      });
    });
  }

  selectLocation(index) {
    if (this.state.selectedLocations.filter(loc => loc === this.state.locations[index]).length === 0) {
      this.setState({
        selectedLocations: [
          ...this.state.selectedLocations,
          this.state.locations[index]
        ]
      })
    } else {
      if (this.state.selectedLocations.length === 1) {
        this.setState({
          selectedLocations: []
        })
      } else {
        this.setState({
          selectedLocations: this.state.selectedLocations.map((loc) => {
            if (loc !== this.state.locations[index]) {
              return loc;
            }
          })
        })
      }
    }
  }

  render() {
    return (
      <div>
        <MapContainer locations={this.state.selectedLocations.length > 0 ? this.state.selectedLocations : this.state.locations} />
        <Pages currentPage={this.state.currentPage} pageLimit={Math.ceil(this.state.totalDataCount/100)} onPageClick={this.onPageClick} />
        <DataGrid data={this.state.data} currentPage={this.state.currentPage} selectLocation={this.selectLocation} onSearchSubmit={this.onSearchSubmit} />
      </div>
    );
  }
}

export default withApollo(DataController);
